'use strict';

/*!
 * Run nightwatch and node server at the same time,
 * exit the server when the test has finished
 */

// close the selenium server in case it's still running previously
require('needle')
.get('http://localhost:4444/selenium-server/driver/?cmd=shutDownSeleniumServer',
function () {

    var spawn = require('child_process').spawn,
        server = spawn('node', ['test/resources/server.js']),
        test = spawn('./node_modules/.bin/nightwatch', ['-c', 'test/e2e/nightwatch.json']);

    server.stdout.on('data', function (message) {
        console.log(message.toString());
    });

    server.stderr.on('data', function (err) {
        console.log(err.toString());
    });

    test.stdout.on('data', function (message) {
        console.log(message.toString());
    });

    test.stderr.on('data', function (err) {
        console.log(err.toString());
    });

    test.on('close', function (code) {
        server.kill('SIGHUP');
        process.exit(code);
    });
});
